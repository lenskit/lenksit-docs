

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Algorithm Implementation Tips &mdash; LensKit 0.12.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  
    <link rel="canonical" href="https://lkpy.readthedocs.io/en/stable/impl-tips.html" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
        <script async="async" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Utility Functions" href="util.html" />
    <link rel="prev" title="Errors and Diagnostics" href="diagnostics.html" /> 

<!-- RTD Extra Head -->

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.org", "build_date": "2021-03-06T22:45:13Z", "builder": "sphinx", "canonical_url": null, "commit": "cc868216", "docroot": "/doc/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "impl-tips", "programming_language": "py", "project": "lkpy", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {}, "theme": "sphinx_rtd_theme", "user_analytics_code": "", "version": "0.12.2"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> LensKit
          

          
          </a>

          
            
            
            
              <div class="version">
                0.12.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install LensKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/lenskit/lkpy/releases">Release Notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Running Experiments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="crossfold.html">Splitting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Batch-Running Recommenders</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation/index.html">Evaluating Recommender Output</a></li>
</ul>
<p class="caption"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interfaces.html">Algorithm Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Algorithm Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">Basic and Utility Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="bias.html">Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="knn.html">k-NN Collaborative Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="mf.html">Classic Matrix Factorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="tf.html">TensorFlow Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="hpf.html">Hierarchical Poisson Factorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="implicit.html">Implicit</a></li>
</ul>
<p class="caption"><span class="caption-text">Tips and Tricks</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Errors and Diagnostics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Algorithm Implementation Tips</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#performance">Performance</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pickling-and-sharing">Pickling and Sharing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#random-number-generation">Random Number Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-map-friendliness">Memory Map Friendliness</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Configuration and Internals</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="util.html">Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="random.html">Random Number Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="internals.html">LensKit Internals</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LensKit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Algorithm Implementation Tips</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/lenskit/lkpy/blob/0.12.2/doc/impl-tips.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="algorithm-implementation-tips">
<h1>Algorithm Implementation Tips<a class="headerlink" href="#algorithm-implementation-tips" title="Permalink to this headline">¶</a></h1>
<p>Implementing algorithms is fun, but there are a few things that are good to keep in mind.</p>
<p>In general, development follows the following:</p>
<ol class="arabic simple">
<li><p>Correct</p></li>
<li><p>Clear</p></li>
<li><p>Fast</p></li>
</ol>
<p>In that order.  Further, we always want LensKit to be <em>usable</em> in an easy fashion.  Code
implementing algorithms, however, may be quite complex in order to achieve good performance.</p>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>We use Numba to optimize critical code paths and provide parallelism in a number of cases,
such as ALS training.  See the ALS source code for examples.</p>
<p>We also directly use MKL sparse matrix routines when available for some operations.  Whenever
this is done in the main LensKit code base, however, we also provide fallback implementations
when the MKL is not available.  The k-NN recommenders both demonstrate different versions of
this.  The <code class="docutils literal notranslate"><span class="pre">_mkl_ops</span></code> module exposes MKL operations; we implement them through C wrappers in
the <code class="docutils literal notranslate"><span class="pre">mkl_ops.c</span></code> file, that are then called through FFI.  This extra layer is because the raw
MKL calls are quite complex to call via FFI, and are not particularly amenable to use with Numba.
We re-expose simplified interfaces that are also usable with Numba.</p>
</div>
<div class="section" id="pickling-and-sharing">
<h2>Pickling and Sharing<a class="headerlink" href="#pickling-and-sharing" title="Permalink to this headline">¶</a></h2>
<p>LensKit uses Python pickling (or JobLib’s modified pickling in <code class="xref py py-func docutils literal notranslate"><span class="pre">joblib.dump()</span></code>) quite
a bit to save and reload models and to share model data between concurrent processes.  This
generally just works, and you don’t need to implement any particular save/load logic in order
to have your algorithm be savable and sharable.</p>
<p>There are a few exceptions, though.</p>
<p><strong>If your algorithm updates state after fitting</strong>, this should <em>not</em> be pickled.  An example of
this would be caching predictions or recommendations to save time in subsequent calls.  Only the
model parameters and estimated parameters should be pickled.  If you have caches or other
ephemeral structures, override <code class="docutils literal notranslate"><span class="pre">__getstate__</span></code> and <code class="docutils literal notranslate"><span class="pre">__setstate__</span></code> to exclude them from the
saved data and to initialize caches to empty values on unpickling.</p>
<p><strong>If your model excludes secondary data structures from pickling</strong>, such as a reverse index of
user-item interactions, then you should only exclude them when pickling for serialization. When
pickling for model sharing (see <a class="reference internal" href="sharing.html#lenskit.sharing.in_share_context" title="lenskit.sharing.in_share_context"><code class="xref py py-func docutils literal notranslate"><span class="pre">lenskit.sharing.in_share_context()</span></code></a>), you should include
the derived structures so they can also be shared.</p>
<p><strong>If your algorithm uses subsidiary models as a part of the training process</strong>, but does not need them
for prediction or recommendation, then consider overriding <code class="docutils literal notranslate"><span class="pre">__getstate__</span></code> to remove the underlying
model or replace it with a cloned copy (with <a class="reference internal" href="util.html#lenskit.util.clone" title="lenskit.util.clone"><code class="xref py py-func docutils literal notranslate"><span class="pre">lenskit.util.clone()</span></code></a>) to reduce serialized
disk space (and deserialized memory use).</p>
</div>
<div class="section" id="random-number-generation">
<h2>Random Number Generation<a class="headerlink" href="#random-number-generation" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="random.html#module-lenskit.util.random" title="lenskit.util.random"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lenskit.util.random</span></code></a> for documentation on how to use random number generation.</p>
<p>In general, algorithms using randomization should have an <code class="docutils literal notranslate"><span class="pre">rng</span></code> parameter that takes a seed
or RNG, and pass this to <a class="reference internal" href="random.html#lenskit.util.random.rng" title="lenskit.util.random.rng"><code class="xref py py-func docutils literal notranslate"><span class="pre">lenskit.util.random.rng()</span></code></a> to get a random number generator.
Algorithms that use randomness at predict or recommendation time, not just training time, should
support the value <code class="docutils literal notranslate"><span class="pre">'user'</span></code> for the <code class="docutils literal notranslate"><span class="pre">rng</span></code> parameter, and if it is passed, derive a new seed
for each user using <a class="reference internal" href="random.html#lenskit.util.random.derive_seed" title="lenskit.util.random.derive_seed"><code class="xref py py-func docutils literal notranslate"><span class="pre">lenskit.util.random.derive_seed()</span></code></a> to allow reproducibility in
the face of parallelism for common experimental designs.  <a class="reference internal" href="random.html#lenskit.util.random.derivable_rng" title="lenskit.util.random.derivable_rng"><code class="xref py py-func docutils literal notranslate"><span class="pre">lenskit.util.random.derivable_rng()</span></code></a>
automates this logic.</p>
</div>
<div class="section" id="memory-map-friendliness">
<h2>Memory Map Friendliness<a class="headerlink" href="#memory-map-friendliness" title="Permalink to this headline">¶</a></h2>
<p>LensKit uses <code class="xref py py-class docutils literal notranslate"><span class="pre">joblib.Parallel</span></code> to parallelize internal operations (when it isn’t using Numba).
Joblib is pretty good about using shared memory to minimize memory overhead in parallel computations,
and LensKit has some tricks to maximize this use. However, it does require a bit of attention in
your algorithm implementation.</p>
<p>The easiest way to make this fail is to use many small NumPy or Pandas data structures.  If you have
a dictionary of <code class="xref py py-class docutils literal notranslate"><span class="pre">np.ndarray</span></code> objects, for instance, it will cause a problem.  This is because
each array will be memory-mapped, and each map will <em>reopen</em> the file.  Having too many active
open files will cause your process to run out of file descriptors on many systems.  Keep your
object count to a small, ideally fixed number; in <code class="xref py py-class docutils literal notranslate"><span class="pre">lenskit.algorithms.basic.UnratedItemSelector</span></code>,
we do this by storing user and item indexes along with a <code class="xref py py-class docutils literal notranslate"><span class="pre">matrix.CSR</span></code> containing the items
rated by each user.  The old implementation had a dictionary mapping user IDs to <a href="#id1"><span class="problematic" id="id2">``</span></a>ndarray``s with
each user’s rated items.  This is a change from <span class="math notranslate nohighlight">\(|U|+1\)</span> arrays to 5 arrays.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="util.html" class="btn btn-neutral float-right" title="Utility Functions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="diagnostics.html" class="btn btn-neutral float-left" title="Errors and Diagnostics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018–2019 Boise State University.
      <span class="commit">
        
        Revision <code>cc868216</code>.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
<p>This material is based upon work supported by the National Science Foundation under
Grant No. <a href="https://md.ekstrandom.net/research/career">IIS 17-51278</a>. Any
opinions, findings, and conclusions or recommendations expressed in this material
are those of the author(s) and do not necessarily reflect the views of the
National Science Foundation.  This page has not been approved by
Boise State University and does not reflect official university positions.</p>
<script data-goatcounter="https://lenskit.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>


</footer>
        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 0.12.2
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
          <dd><a href="/en/0.12.2/">0.12.2</a></dd>
        
          <dd><a href="/en/0.12.1/">0.12.1</a></dd>
        
          <dd><a href="/en/0.12.0/">0.12.0</a></dd>
        
          <dd><a href="/en/0.11.1/">0.11.1</a></dd>
        
          <dd><a href="/en/0.11.0/">0.11.0</a></dd>
        
          <dd><a href="/en/0.10.1/">0.10.1</a></dd>
        
          <dd><a href="/en/0.10.0/">0.10.0</a></dd>
        
          <dd><a href="/en/0.9.0/">0.9.0</a></dd>
        
          <dd><a href="/en/0.8.4/">0.8.4</a></dd>
        
          <dd><a href="/en/0.8.1/">0.8.1</a></dd>
        
          <dd><a href="/en/0.8.0/">0.8.0</a></dd>
        
          <dd><a href="/en/0.7.0/">0.7.0</a></dd>
        
          <dd><a href="/en/0.6.1/">0.6.1</a></dd>
        
          <dd><a href="/en/0.6.0/">0.6.0</a></dd>
        
          <dd><a href="/en/0.5.0/">0.5.0</a></dd>
        
          <dd><a href="/en/0.3.0/">0.3.0</a></dd>
        
          <dd><a href="/en/0.2.0/">0.2.0</a></dd>
        
          <dd><a href="/en/0.1.0/">0.1.0</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/lkpy/?fromdocs=lkpy">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/lkpy/?fromdocs=lkpy">Builds</a>
          </dd>
      </dl>
    </div>
  </div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>