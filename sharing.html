<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Model Sharing &mdash; LensKit 0.14.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=a9ba800c"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="/_/static/javascript/readthedocs-doc-embed.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Parallel Execution" href="parallel.html" />
    <link rel="prev" title="LensKit Internals" href="internals.html" /> 

<!-- RTD Extra Head -->

<link rel="stylesheet" href="/_/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="application/json" id="READTHEDOCS_DATA">{"ad_free": false, "api_host": "https://readthedocs.org", "builder": "sphinx", "canonical_url": null, "docroot": "/docs/", "features": {"docsearch_disabled": false}, "global_analytics_code": "UA-17997319-1", "language": "en", "page": "sharing", "programming_language": "py", "project": "lkpy", "proxied_api_host": "/_", "source_suffix": ".rst", "subprojects": {"lenskit-hpf": "https://lkpy.readthedocs.io/projects/lenskit-hpf/en/stable/", "lenskit-implicit": "https://lkpy.readthedocs.io/projects/lenskit-implicit/en/latest/", "lenskit-tf": "https://lkpy.readthedocs.io/projects/lenskit-tf/en/latest/"}, "theme": "sphinx_rtd_theme", "user_analytics_code": "", "version": "0.14.3"}</script>

<!--
Using this variable directly instead of using `JSON.parse` is deprecated.
The READTHEDOCS_DATA global variable will be removed in the future.
-->
<script type="text/javascript">
READTHEDOCS_DATA = JSON.parse(document.getElementById('READTHEDOCS_DATA').innerHTML);
</script>

<script type="text/javascript" src="/_/static/javascript/readthedocs-analytics.js" async="async"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            LensKit
          </a>
              <div class="version">
                0.14.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Install LensKit</a></li>
<li class="toctree-l1"><a class="reference internal" href="GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/lenskit/lkpy/releases">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Running Experiments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="datasets.html">Loading Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="crossfold.html">Splitting Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="batch.html">Batch-Running Recommenders</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation/index.html">Evaluating Recommender Output</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interfaces.html">Algorithm Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms.html">Algorithm Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic.html">Basic and Utility Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="ranking.html">Ranking Methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="bias.html">Bias</a></li>
<li class="toctree-l1"><a class="reference internal" href="knn.html">k-NN Collaborative Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="mf.html">Classic Matrix Factorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="addons.html">Add-On Algorithms</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tips and Tricks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Performance Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Errors and Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="impl-tips.html">Algorithm Implementation Tips</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Configuration and Internals</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="util.html">Utility Functions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="internals.html">LensKit Internals</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Model Sharing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sharing-mode">Sharing Mode</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lenskit.sharing.in_share_context"><code class="docutils literal notranslate"><span class="pre">in_share_context()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#lenskit.sharing.sharing_mode"><code class="docutils literal notranslate"><span class="pre">sharing_mode()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#persistence-api">Persistence API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#lenskit.sharing.persist"><code class="docutils literal notranslate"><span class="pre">persist()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#lenskit.sharing.PersistedModel"><code class="docutils literal notranslate"><span class="pre">PersistedModel</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="parallel.html">Parallel Execution</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LensKit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="internals.html">LensKit Internals</a></li>
      <li class="breadcrumb-item active">Model Sharing</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/lenskit/lkpy/blob/0.14.3/docs/sharing.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-lenskit.sharing">
<span id="model-sharing"></span><h1>Model Sharing<a class="headerlink" href="#module-lenskit.sharing" title="Link to this heading"></a></h1>
<p>The <a class="reference internal" href="#module-lenskit.sharing" title="lenskit.sharing"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lenskit.sharing</span></code></a> module provides utilities for managing models and sharing them
between processes, particularly for the  multiprocessing in <a class="reference internal" href="batch.html#module-lenskit.batch" title="lenskit.batch"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lenskit.batch</span></code></a>.</p>
<section id="sharing-mode">
<h2>Sharing Mode<a class="headerlink" href="#sharing-mode" title="Link to this heading"></a></h2>
<p>The only piece <strong>algorithm developers</strong> usually need to directly handle is the concept of
‘sharing mode’ when implementing custom pickling logic.  To save space, it is reasonable to
exclude intermediate data structures, such as caches or inverse indexes, from the pickled
representation of an algorithm, and reconstruct them when the model is loaded.</p>
<p>However, LensKit’s multi-process sharing <em>also</em> uses pickling to capture the object state
while using shared memory for <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.26)"><code class="xref py py-class docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> objects.  In these cases, the structures
should be pickled, so they can be shared between model instances.</p>
<p>To support this, we have the concept of <em>sharing mode</em>.  Code that excludes objects when
pickling should call <a class="reference internal" href="#lenskit.sharing.in_share_context" title="lenskit.sharing.in_share_context"><code class="xref py py-func docutils literal notranslate"><span class="pre">in_share_context()</span></code></a> to determine if that exclusion should
actually happen.</p>
<dl class="py function">
<dt class="sig sig-object py" id="lenskit.sharing.in_share_context">
<span class="sig-prename descclassname"><span class="pre">lenskit.sharing.</span></span><span class="sig-name descname"><span class="pre">in_share_context</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.in_share_context" title="Link to this definition"></a></dt>
<dd><p>Query whether sharing mode is active.  If <code class="docutils literal notranslate"><span class="pre">True</span></code>, we are currently in a
<a class="reference internal" href="#lenskit.sharing.sharing_mode" title="lenskit.sharing.sharing_mode"><code class="xref py py-func docutils literal notranslate"><span class="pre">sharing_mode()</span></code></a> context, which means model pickling will be used for
cross-process sharing.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="lenskit.sharing.sharing_mode">
<span class="sig-prename descclassname"><span class="pre">lenskit.sharing.</span></span><span class="sig-name descname"><span class="pre">sharing_mode</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.sharing_mode" title="Link to this definition"></a></dt>
<dd><p>Context manager to tell models that pickling will be used for cross-process
sharing, not model persistence.</p>
</dd></dl>

</section>
<section id="persistence-api">
<h2>Persistence API<a class="headerlink" href="#persistence-api" title="Link to this heading"></a></h2>
<p>These functions are used for internal LensKit infrastructure code to persist models into
shared memory for parallel processing.</p>
<dl class="py function">
<dt class="sig sig-object py" id="lenskit.sharing.persist">
<span class="sig-prename descclassname"><span class="pre">lenskit.sharing.</span></span><span class="sig-name descname"><span class="pre">persist</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">method</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.persist" title="Link to this definition"></a></dt>
<dd><p>Persist a model for cross-process sharing.</p>
<p>This will return a persisted model that can be used to reconstruct the model
in a worker process (using <a class="reference internal" href="#lenskit.sharing.PersistedModel.get" title="lenskit.sharing.PersistedModel.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">PersistedModel.get()</span></code></a>).</p>
<p>If no method is provided, this function automatically selects a model persistence
strategy from the the following, in order:</p>
<ol class="arabic simple">
<li><p>If <cite>LK_TEMP_DIR</cite> is set, use <code class="xref py py-mod docutils literal notranslate"><span class="pre">binpickle</span></code> in shareable mode to save
the object into the LensKit temporary directory.</p></li>
<li><p>If <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.shared_memory.html#module-multiprocessing.shared_memory" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">multiprocessing.shared_memory</span></code></a> is available, use <a class="reference external" href="https://docs.python.org/3/library/pickle.html#module-pickle" title="(in Python v3.12)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pickle</span></code></a>
to save the model, placing the buffers into shared memory blocks.</p></li>
<li><p>Otherwise, use <code class="xref py py-mod docutils literal notranslate"><span class="pre">binpickle</span></code> in shareable mode to save the object
into the system temporary directory.</p></li>
</ol>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>model</strong> (<em>obj</em>) – The model to persist.</p></li>
<li><p><strong>method</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.12)"><em>str</em></a><em> or </em><em>None</em>) – The method to use.  Can be one of <code class="docutils literal notranslate"><span class="pre">binpickle</span></code> or <code class="docutils literal notranslate"><span class="pre">shm</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>The persisted object.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference internal" href="#lenskit.sharing.PersistedModel" title="lenskit.sharing.PersistedModel">PersistedModel</a></p>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="lenskit.sharing.PersistedModel">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">lenskit.sharing.</span></span><span class="sig-name descname"><span class="pre">PersistedModel</span></span><a class="headerlink" href="#lenskit.sharing.PersistedModel" title="Link to this definition"></a></dt>
<dd><p>Bases: <a class="reference external" href="https://docs.python.org/3/library/abc.html#abc.ABC" title="(in Python v3.12)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ABC</span></code></a></p>
<p>A persisted model for inter-process model sharing.</p>
<p>These objects can be pickled for transmission to a worker process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Subclasses need to override the pickling protocol to implement the
proper pickling implementation.</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="lenskit.sharing.PersistedModel.get">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.PersistedModel.get" title="Link to this definition"></a></dt>
<dd><p>Get the persisted model, reconstructing it if necessary.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="lenskit.sharing.PersistedModel.close">
<em class="property"><span class="pre">abstract</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">close</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.PersistedModel.close" title="Link to this definition"></a></dt>
<dd><p>Release the persisted model resources.  Should only be called in the
parent process (will do nothing in a child process).</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="lenskit.sharing.PersistedModel.transfer">
<span class="sig-name descname"><span class="pre">transfer</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#lenskit.sharing.PersistedModel.transfer" title="Link to this definition"></a></dt>
<dd><p>Mark an object for ownership transfer.  This object, when pickled, will
unpickle into an owning model that frees resources when closed. Used to
transfer ownership of shared memory resources from child processes to
parent processes.  Such an object should only be unpickled once.</p>
<p>The default implementation sets the <code class="docutils literal notranslate"><span class="pre">is_owner</span></code> attribute to <code class="docutils literal notranslate"><span class="pre">'transfer'</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns<span class="colon">:</span></dt>
<dd class="field-odd"><p><code class="docutils literal notranslate"><span class="pre">self</span></code> (for convenience)</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="internals.html" class="btn btn-neutral float-left" title="LensKit Internals" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="parallel.html" class="btn btn-neutral float-right" title="Parallel Execution" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018–2019 Boise State University.
      <span class="commit">Revision <code>f34809ae</code>.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
<p>This material is based upon work supported by the National Science Foundation under
Grant No. <a href="https://md.ekstrandom.net/research/career">IIS 17-51278</a>. Any
opinions, findings, and conclusions or recommendations expressed in this material
are those of the author(s) and do not necessarily reflect the views of the
National Science Foundation.  This page has not been approved by
Boise State University and does not reflect official university positions.</p>
<script data-goatcounter="https://lenskit.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>


</footer>
        </div>
      </div>
    </section>
  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 0.14.3
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
          <dd><a href="/en/stable/">stable</a></dd>
        
          <dd><a href="/en/0.14.3/">0.14.3</a></dd>
        
          <dd><a href="/en/0.14.2/">0.14.2</a></dd>
        
          <dd><a href="/en/0.14.1/">0.14.1</a></dd>
        
          <dd><a href="/en/0.14.0/">0.14.0</a></dd>
        
          <dd><a href="/en/0.13.1/">0.13.1</a></dd>
        
          <dd><a href="/en/0.13.0/">0.13.0</a></dd>
        
          <dd><a href="/en/0.12.3/">0.12.3</a></dd>
        
          <dd><a href="/en/0.12.2/">0.12.2</a></dd>
        
          <dd><a href="/en/0.12.1/">0.12.1</a></dd>
        
          <dd><a href="/en/0.12.0/">0.12.0</a></dd>
        
          <dd><a href="/en/0.11.1/">0.11.1</a></dd>
        
          <dd><a href="/en/0.11.0/">0.11.0</a></dd>
        
          <dd><a href="/en/0.10.1/">0.10.1</a></dd>
        
          <dd><a href="/en/0.10.0/">0.10.0</a></dd>
        
          <dd><a href="/en/0.9.0/">0.9.0</a></dd>
        
          <dd><a href="/en/0.8.4/">0.8.4</a></dd>
        
          <dd><a href="/en/0.8.1/">0.8.1</a></dd>
        
          <dd><a href="/en/0.8.0/">0.8.0</a></dd>
        
          <dd><a href="/en/0.7.0/">0.7.0</a></dd>
        
          <dd><a href="/en/0.6.1/">0.6.1</a></dd>
        
          <dd><a href="/en/0.6.0/">0.6.0</a></dd>
        
          <dd><a href="/en/0.5.0/">0.5.0</a></dd>
        
          <dd><a href="/en/0.3.0/">0.3.0</a></dd>
        
          <dd><a href="/en/0.2.0/">0.2.0</a></dd>
        
          <dd><a href="/en/0.1.0/">0.1.0</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/lkpy/?fromdocs=lkpy">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/lkpy/?fromdocs=lkpy">Builds</a>
          </dd>
      </dl>
    </div>
  </div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>